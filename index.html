<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Scrolling Through the Arctic</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        body { margin: 0; overflow-x: hidden; font-family: 'Segoe UI', sans-serif; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        #app-container { transition: background-color 0.5s linear; }
        @keyframes twinkle {
            0%, 100% { opacity: 0.8; transform: scale(1); }
            50% { opacity: 0.3; transform: scale(0.8); }
        }
        .star { animation: twinkle 3s infinite ease-in-out; }
        .tooltip {
    transition: opacity 0.5s ease, transform 0.5s ease;
    pointer-events: none;
}
.tooltip.hidden {
    opacity: 0;
    transform: translateY(20px);
}
.tooltip.visible {
    opacity: 1;
    transform: translateY(0);
}
        .modal { transition: opacity 0.3s ease, pointer-events 0.3s ease; }
        .modal.hidden-modal { opacity: 0; pointer-events: none; }
        .modal.visible-modal { opacity: 1; pointer-events: auto; }
        .loader {
            border: 4px solid rgba(255, 255, 255, 0.1);
            border-left-color: #ffffff;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="bg-gray-900 text-white">
    <div id="loading-screen" class="fixed inset-0 z-[60] bg-gray-900 flex flex-col items-center justify-center transition-opacity duration-500">
        <div class="loader mb-4"></div>
        <p class="text-blue-200 text-sm tracking-widest uppercase">Loading Satellite Data...</p>
        <p id="loading-subtext" class="text-blue-200/50 text-xs mt-2">Connecting to modis_arctic_2023.json...</p>
    </div>
    <div id="app-container" class="fixed inset-0 w-full h-full overflow-hidden opacity-0 transition-opacity duration-1000">
        <div id="stars-layer" class="absolute inset-0 transition-opacity duration-1000" style="opacity: 0;">
        </div>
        <div id="clouds-layer" class="absolute inset-0 pointer-events-none mix-blend-overlay transition-opacity duration-1000" 
             style="background: repeating-linear-gradient(45deg, transparent, transparent 100px, rgba(255,255,255,0.1) 100px, rgba(255,255,255,0.1) 200px);">
        </div>
        <div id="cloud-visual-container"></div>
        <div class="absolute inset-0 flex items-end justify-center pb-20 pointer-events-none">
            <div id="celestial-body" class="relative w-[150vw] h-[150vw] rounded-full border border-white/5 transition-transform duration-75 linear origin-center">
                <div class="absolute top-1/2 -right-12 w-24 h-24 bg-yellow-300 rounded-full blur-xl shadow-[0_0_100px_rgba(253,224,71,0.6)]"></div>
                <div class="absolute top-1/2 -right-12 w-24 h-24 bg-yellow-100 rounded-full shadow-2xl"></div>
                <div class="absolute top-1/2 -left-12 w-20 h-20 bg-gray-200 rounded-full shadow-[0_0_50px_rgba(255,255,255,0.2)] opacity-80">
                    <div class="w-4 h-4 bg-gray-300 rounded-full absolute top-4 left-4 opacity-50"></div>
                    <div class="w-6 h-6 bg-gray-300 rounded-full absolute bottom-6 right-6 opacity-50"></div>
                </div>
            </div>
        </div>
        <div class="absolute inset-0 flex flex-col justify-between p-6 md:p-12 z-50 pointer-events-none">
            <div class="flex justify-between items-start pointer-events-auto">
                <div>
                    <h1 class="text-4xl md:text-6xl font-black tracking-tighter drop-shadow-lg">
                        SCROLLING<br/>
                        <span class="text-transparent bg-clip-text bg-gradient-to-r from-blue-300 to-white">
                            THROUGH THE ARCTIC
                        </span>
                    </h1>
                    <p class="text-blue-100 mt-2 max-w-md drop-shadow-md text-sm md:text-base">
                        A 24-hour visual journey exploring daylight, brightness, and cloud patterns.
                    </p>
                    <button id="info-btn" class="mt-4 px-4 py-2 bg-white/20 hover:bg-white/30 rounded-full text-xs font-bold uppercase tracking-widest backdrop-blur-sm border border-white/10 transition-all flex items-center gap-2">
                        <i data-lucide="info" class="w-4 h-4"></i> Project Info & Writeup
                    </button>
                </div>
                <div class="hidden md:block text-right">
                    <p class="text-white/60 text-sm uppercase tracking-widest">Current Time</p>
                    <p id="time-display" class="text-6xl font-mono font-bold tabular-nums drop-shadow-lg">00:00</p>
                </div>
            </div>
            <div id="tooltip-container" class="absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 w-full max-w-4xl h-full pointer-events-none">
            </div>
            <div class="pointer-events-auto space-y-6 w-full">
                <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                    <div class="bg-white/10 backdrop-blur-md border border-white/20 p-4 rounded-xl flex items-center shadow-lg">
                        <div id="vis-brightness" class="w-16 h-16 mr-4 flex items-center justify-center"></div>
                        <div>
                            <p class="text-blue-200 text-xs font-medium uppercase tracking-wider">Brightness Index</p>
                            <p id="val-brightness" class="text-2xl font-bold">0</p>
                        </div>
                    </div>
                    <div class="bg-white/10 backdrop-blur-md border border-white/20 p-4 rounded-xl flex items-center shadow-lg">
                        <div id="vis-cloud" class="w-16 h-16 mr-4 flex items-center justify-center"></div>
                        <div>
                            <p class="text-blue-200 text-xs font-medium uppercase tracking-wider">Cloud Cover</p>
                            <p id="val-cloud" class="text-2xl font-bold">0%</p>
                        </div>
                    </div>
                    <div class="bg-white/10 backdrop-blur-md border border-white/20 p-4 rounded-xl flex items-center space-x-4 shadow-lg">
                        <i data-lucide="clock" class="text-blue-300 w-6 h-6"></i>
                        <div>
                            <p class="text-blue-200 text-xs font-medium uppercase tracking-wider">Daylight Hours</p>
                            <p id="val-daylight" class="text-2xl font-bold">0h</p>
                            <p class="text-[10px] text-blue-300/60 uppercase">Seasonal Avg</p>
                        </div>
                    </div>
                    <div class="bg-white/10 backdrop-blur-md border border-white/20 p-4 rounded-xl flex flex-col justify-center space-y-2 shadow-lg">
                        <span class="text-blue-200 text-xs font-medium uppercase tracking-wider">Season</span>
                        <div class="flex space-x-1 bg-black/20 p-1 rounded-lg" id="season-controls">
                        </div>
                    </div>
                </div>
                <div class="bg-black/40 backdrop-blur-md rounded-2xl p-4 border border-white/10 overflow-x-auto no-scrollbar">
                    <div class="flex space-x-6 min-w-max" id="location-controls">
                    </div>
                </div>
                <div id="scroll-hint" class="text-center w-full pb-4">
                    <p class="text-white text-xs uppercase tracking-widest animate-bounce">Scroll Down to Advance Time</p>
                </div>
            </div>
        </div>
    </div>
    <div id="info-modal" class="fixed inset-0 z-[100] bg-black/90 backdrop-blur-xl flex items-center justify-center modal hidden-modal p-4">
        <div class="bg-gray-800 border border-gray-700 w-full max-w-2xl rounded-2xl p-8 shadow-2xl overflow-y-auto max-h-[90vh]">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold text-white">Project Prototype Info</h2>
                <button id="close-modal-btn" class="p-2 hover:bg-white/10 rounded-full transition-colors">
                    <i data-lucide="x" class="text-white"></i>
                </button>
            </div>
            
            <div class="space-y-6 text-gray-300 leading-relaxed">
                <div class="border-b border-gray-700 pb-4">
                    <h3 class="text-sm uppercase tracking-wider text-blue-400 font-bold mb-2">Team Members</h3>
                    <ul class="list-disc pl-5 space-y-1">
                        <li>Amrutha Potluri</li>
                        <li>Audrey Chung</li>
                        <li>Katie Hannigan</li>
                        <li>Faline Le</li>
                    </ul>
                </div>
                <div>
                    <h3 class="text-sm uppercase tracking-wider text-blue-400 font-bold mb-2">1. What have you done so far?</h3>
                    <p>
                        We have successfully implemented the core "scrollytelling" architecture of our project using HTML, CSS, and D3.js. 
                        Currently, the application simulates a 24-hour cycle in the Arctic, allowing users to scroll to progress time 
                        and observe changes in sky color, sunlight, and environmental conditions. We have integrated our real NASA MODIS dataset (2023),
                        allowing users to toggle between different Arctic sites and seasons to see real averages for Cloud Cover and Surface Brightness.
                    </p>
                </div>
                <div>
                    <h3 class="text-sm uppercase tracking-wider text-blue-400 font-bold mb-2">2. What will be the most challenging part of your project to design and why?</h3>
                    <p>
                        The most challenging aspect will be refining the visual transitions. While we now have the real data points, mapping the 
                        continuous "24-hour scroll" to these static seasonal averages requires careful design. Specifically, visualizing the "Midnight Sun" 
                        (where the sun never sets) versus "Polar Night" (where it never rises) purely through code-driven animation is difficult. 
                        We need to ensure the sun's trajectory on screen accurately reflects the `daylightHours` data point we just imported.
                    </p>
                </div>
            </div>
        </div>
    </div>
    <div style="height: 800vh;"></div>

    <script>
        let ARCTIC_DATA = [];
        let LOCATIONS = [];
        const SEASONS = ["Winter", "Spring", "Summer", "Fall"];
        let state = {
            scrollProgress: 0,
            season: "Spring",
            location: "Longyearbyen, Svalbard",
            currentTime: 0
        };
        const setupGauge = (elementId, color) => {
            const width = 64, height = 64;
            const svg = d3.select(elementId).html("").append("svg")
                .attr("width", width)
                .attr("height", height)
                .append("g")
                .attr("transform", `translate(${width/2},${height/2})`);
            const arcBg = d3.arc().innerRadius(20).outerRadius(28).startAngle(0).endAngle(2 * Math.PI);
            svg.append("path").attr("d", arcBg).attr("fill", "rgba(255,255,255,0.1)");
            const arcFg = d3.arc().innerRadius(20).outerRadius(28).cornerRadius(5);
            const path = svg.append("path").datum({endAngle: 0}).attr("fill", color).attr("d", arcFg);
            return { path, arcFg };
        };
        const brightGauge = setupGauge("#vis-brightness", "#fbbf24");
        const cloudGauge = setupGauge("#vis-cloud", "#60a5fa");
        const updateGauge = (gaugeObj, value, max) => {
            const angle = (value / max) * 2 * Math.PI;
            gaugeObj.path.transition().duration(500).attrTween("d", function(d) {
                const interpolate = d3.interpolate(d.endAngle, angle);
                return function(t) {
                    d.endAngle = interpolate(t);
                    return gaugeObj.arcFg(d);
                };
            });
        };
        function initializeUI() {
            const seasonContainer = document.getElementById("season-controls");
            const locContainer = document.getElementById("location-controls");
            seasonContainer.innerHTML = '';
            locContainer.innerHTML = '';
            SEASONS.forEach((s) => {
                const btn = document.createElement("button");
                btn.className = `flex-1 py-1 px-2 text-xs rounded-md transition-colors ${s === state.season ? 'bg-white text-black font-bold' : 'text-white/60 hover:bg-white/10'}`;
                btn.textContent = s;
                btn.onclick = () => {
                    state.season = s;
                    updateSeasonButtons();
                    render();
                };
                seasonContainer.appendChild(btn);
            });
            LOCATIONS.forEach((loc) => {
                const btn = document.createElement("button");
                btn.className = `group flex items-center space-x-2 transition-all duration-300 min-w-max`;
                btn.innerHTML = `
                    <div class="p-2 rounded-full transition-colors ${loc === state.location ? 'bg-yellow-400 text-black' : 'bg-white/10 text-white'}">
                        <i data-lucide="map-pin" class="w-4 h-4"></i>
                    </div>
                    <span class="text-sm font-medium ${loc === state.location ? 'text-white' : 'text-gray-300'}">${loc}</span>
                `;
                btn.onclick = () => {
                    state.location = loc;
                    updateLocationButtons();
                    render();
                };
                locContainer.appendChild(btn);
            });
            document.getElementById("loading-screen").style.opacity = 0;
            setTimeout(() => {
                document.getElementById("loading-screen").style.display = 'none';
                document.getElementById("app-container").style.opacity = 1;
            }, 500);
            lucide.createIcons();
            render();
        }
        function updateSeasonButtons() {
            const sBtns = document.getElementById("season-controls").querySelectorAll("button");
            sBtns.forEach((btn, i) => {
                const s = SEASONS[i];
                btn.className = `flex-1 py-1 px-2 text-xs rounded-md transition-colors ${s === state.season ? 'bg-white text-black font-bold' : 'text-white/60 hover:bg-white/10'}`;
            });
        }
        function updateLocationButtons() {
            const buttons = document.getElementById("location-controls").querySelectorAll("button");
            buttons.forEach((btn, i) => {
                const loc = LOCATIONS[i];
                const iconContainer = btn.querySelector("div");
                const text = btn.querySelector("span");
                if(loc === state.location) {
                    iconContainer.className = "p-2 rounded-full transition-colors bg-yellow-400 text-black";
                    text.className = "text-sm font-medium text-white";
                } else {
                    iconContainer.className = "p-2 rounded-full transition-colors bg-white/10 text-white";
                    text.className = "text-sm font-medium text-gray-300";
                }
            });
        }
        function getSeasonStats(site, season) {
            if (!ARCTIC_DATA.length) return { brightness: 0, cloud: 0, daylight: 0 };
            const relevantData = ARCTIC_DATA.filter(d => d.site === site && d.season === season);
            if (relevantData.length === 0) return { brightness: 0, cloud: 0, daylight: 0 };
            const avg = (field) => Math.round(relevantData.reduce((sum, d) => sum + d[field], 0) / relevantData.length * 10) / 10;
            
            return {
                brightness: avg('brightnessIndex'),
                cloud: avg('cloudCover'),
                daylight: avg('daylightHours')
            };
        }
        function getSkyColor(t, season) {
            if(season === "Winter") {
                 const distFromNoon = Math.abs(12 - t);
                 const lightness = Math.max(5, 20 - distFromNoon * 2);
                 return `hsl(220, 60%, ${lightness}%)`;
            }
            if(season === "Summer") {
                const distFromNoon = Math.abs(12 - t);
                const lightness = 80 - (distFromNoon * 2); 
                return `hsl(190, 80%, ${Math.max(40, lightness)}%)`;
            }
            if (t < 5 || t > 19) return `hsl(220, 80%, 10%)`;
            if (t < 7 || t > 17) return `hsl(20, 70%, 60%)`;
            return `hsl(195, 90%, 70%)`;
        }
        function render() {
            if (!ARCTIC_DATA.length) return;
            const stats = getSeasonStats(state.location, state.season);
            updateGauge(brightGauge, stats.brightness, 100);
            updateGauge(cloudGauge, stats.cloud, 100);
            document.getElementById("val-brightness").innerText = stats.brightness;
            document.getElementById("val-cloud").innerText = stats.cloud + "%";
            document.getElementById("val-daylight").innerText = stats.daylight + "h";
            const t = state.currentTime;
            const skyColor = getSkyColor(t, state.season);
            document.getElementById("app-container").style.backgroundColor = skyColor;
            let rotation = (t / 24) * 360 - 90;
            const sun = document.getElementById("celestial-body");
            sun.style.opacity = stats.daylight < 1 ? 0.2 : 1;
            sun.style.transform = `rotate(${rotation}deg)`;
            updateCloudsDensity(stats.cloud);
            const h = Math.floor(t);
            const m = Math.floor((t - h) * 60);
            document.getElementById("time-display").innerText = `${h.toString().padStart(2, '0')}:${m.toString().padStart(2, '0')}`;
            updateStars(h, state.season);
            updateTooltips(h);
        }

        // Tooltip functions
        let tooltipTimer;
        let currentTooltip = null;
        let lastTooltipKey = null;
        function showTooltip(text, posClass, key) {
            if (lastTooltipKey === key) return; 
            const container = document.getElementById("tooltip-container");
            if (currentTooltip) {
                currentTooltip.classList.replace("visible", "hidden");
                clearTimeout(tooltipTimer);
                setTimeout(() => currentTooltip?.remove(), 1500);
            }
            const div = document.createElement("div");
            div.className = `absolute bg-black/80 backdrop-blur-md border border-yellow-400/30 text-yellow-50 p-4 rounded-lg shadow-2xl tooltip hidden ${posClass}`;
            div.innerHTML = `
                <div class="flex items-start space-x-3">
                    <i data-lucide="info" class="text-yellow-400 shrink-0 w-4 h-4 mt-1"></i>
                    <p class="text-sm leading-relaxed">${text}</p>
                </div>
            `;
            container.appendChild(div);
            lucide.createIcons();
            requestAnimationFrame(() => div.classList.replace("hidden", "visible"));
            currentTooltip = div;
            lastTooltipKey = key;
            tooltipTimer = setTimeout(() => {
            div.classList.replace("visible", "hidden");
            setTimeout(() => {
                    if (currentTooltip === div) currentTooltip = null;
                    div.remove();
                }, 500);
            }, 3000);
        }

        function updateTooltips(hour) {
            let key = `${state.season}-${hour}`;
            if (hour === 0) {
                if (state.season === "Summer") {
                    showTooltip(
                        "The Midnight Sun. In the Arctic summer, the sun never fully sets.",
                        "top-0 left-1/2 -translate-x-1/2",
                        key
                    );
                } else if (state.season === "Winter") {
                    showTooltip(
                        "Polar Night. In winter, the sun stays below the horizon.",
                        "top-0 left-1/2 -translate-x-1/2",
                        key
                    );
                } else if (state.season === "Spring") {
                    showTooltip(
                        "Midnight in spring. Daylight increases as the Arctic moves toward summer.",
                        "top-0 left-1/2 -translate-x-1/2",
                        key
                    );
                } else if (state.season === "Fall") {
                    showTooltip(
                    "Midnight in fall. Daylight decreases as the Arctic moves toward winter.",
                    "top-0 left-1/2 -translate-x-1/2",
                    key
                    );
                }
            }
            if (hour === 12) {
                if (state.season === "Winter") {
                    showTooltip(
                        "Even at noon during Polar Night, the sun barely rises above the horizon.",
                        "top-0 left-1/2 -translate-x-1/2",
                        key
                    );
                } else if (state.season === "Summer") {
                    showTooltip(
                        "Noon under the Midnight Sun. The sun is high and the Arctic experiences continuous daylight.",
                        "top-0 left-1/2 -translate-x-1/2",
                        key
                    );
                } else {
                    showTooltip(
                        "Noon. Maximum daily brightness.",
                        "top-0 left-1/2 -translate-x-1/2",
                        key
                    );
                }
            }
            if ((hour === 6 || hour === 18) && state.season !== "Summer" && state.season !== "Winter") {
                showTooltip(
                    hour === 6
                        ? "Sunrise. The Arctic landscape begins to brighten."
                        : "Sunset. The Arctic landscape starts to darken.",
                    "top-0 left-1/2 -translate-x-1/2",
                    key
                );
            }
        const stats = getSeasonStats(state.location, state.season);
            if (hour === 9 && stats.cloud > 60) {
                showTooltip(
                    "Morning clouds are dense, reducing surface brightness.",
                    "top-0 left-1/2 -translate-x-1/2",
                    key
                );
            }
            if (hour === 15 && stats.brightness > 80) {
                showTooltip(
                    "Afternoon sun is strong, increasing surface brightness.",
                    "top-0 left-1/2 -translate-x-1/2",
                    key
                );
            }
        }

        let scrollPauseTimer;
        window.addEventListener('scroll', () => {
        const totalHeight = document.documentElement.scrollHeight - window.innerHeight;
        state.scrollProgress = Math.min(Math.max(window.scrollY / totalHeight, 0), 1);
        state.currentTime = state.scrollProgress * 24;
        const hint = document.getElementById("scroll-hint");
        hint.style.opacity = state.scrollProgress > 0.05 ? 0 : 1;
        render();
        clearTimeout(scrollPauseTimer);
        scrollPauseTimer = setTimeout(() => {
            updateTooltips(Math.floor(state.currentTime));
            }, 500);
        });

        window.addEventListener('scroll', () => {
            const totalHeight = document.documentElement.scrollHeight - window.innerHeight;
            const progress = window.scrollY / totalHeight;
            state.scrollProgress = Math.min(Math.max(progress, 0), 1);
            state.currentTime = state.scrollProgress * 24;
            const hint = document.getElementById("scroll-hint");
            if(state.scrollProgress > 0.05) hint.style.opacity = 0;
            else hint.style.opacity = 1;
            render();
        });
        
        
        // Star functions
        function generateStars() {
            const layer = document.getElementById("stars-layer");
            layer.innerHTML = "";
            starsArray = [];
            for(let i=0; i<50; i++) {
                const star = document.createElement("div");
                star.className = "absolute bg-white rounded-full star";
                star.style.top = Math.random() * 100 + "%";
                star.style.left = Math.random() * 100 + "%";
                const size = Math.random() * 3 + "px";
                star.style.width = size;
                star.style.height = size;
                star.style.animationDelay = Math.random() * 3 + "s";
                layer.appendChild(star);
            }
        }
        function updateStars(hour, season) {
            const starsLayer = document.getElementById("stars-layer");
            if (season === "Summer") {
                starsLayer.style.opacity = (hour < 1 || hour > 23) ? 0.05 : 0;
            } else {
                let nightFactor = 0;
                if (hour >= 18) nightFactor = (hour - 18) / 6;   
                else if (hour < 6) nightFactor = (6 - hour) / 6;
                nightFactor = Math.min(Math.max(nightFactor, 0), 1);
                starsLayer.style.opacity = nightFactor;
                starsArray.forEach(star => {
                    star.style.opacity = 0.3 + 0.7 * nightFactor * Math.random();
                });
            }
        }
        generateStars();

        const modal = document.getElementById("info-modal");
        const openBtn = document.getElementById("info-btn");
        const closeBtn = document.getElementById("close-modal-btn");

        openBtn.addEventListener("click", () => {
            modal.classList.remove("hidden-modal");
            modal.classList.add("visible-modal");
        });

        closeBtn.addEventListener("click", () => {
            modal.classList.remove("visible-modal");
            modal.classList.add("hidden-modal");
        });

        
        lucide.createIcons();
        d3.json("modis_arctic_2023.json")
          .then(data => {
              ARCTIC_DATA = data;
              LOCATIONS = [...new Set(ARCTIC_DATA.map(d => d.site))];
              console.log("Data loaded successfully:", ARCTIC_DATA.length, "rows");
              initializeUI();
          })
          .catch(error => {
              console.error("Error loading JSON:", error);
              const loader = document.getElementById("loading-screen");
              loader.innerHTML = `
                <div class="text-red-400 text-center p-4 max-w-md">
                    <div class="mb-4 flex justify-center"><i data-lucide="alert-triangle" class="w-10 h-10"></i></div>
                    <p class="font-bold text-lg mb-2">Data Loading Failed</p>
                    <p class="text-sm text-gray-300">The application could not load <code>modis_arctic_2023.json</code>.</p>
                    <div class="mt-4 bg-black/40 p-3 rounded text-left text-xs font-mono text-gray-400">
                        <p class="mb-1 text-yellow-400 font-bold">Possible Fixes:</p>
                        <ul class="list-disc pl-4 space-y-1">
                            <li>Ensure the JSON file is in the same folder as this HTML file.</li>
                            <li>You must run this via a <strong>Local Server</strong> (e.g., Live Server in VS Code) or <strong>GitHub Pages</strong>.</li>
                            <li>Browser security blocks reading files directly from disk (file://).</li>
                        </ul>
                    </div>
                </div>
              `;
              lucide.createIcons();

          });

        // Cloud functions
        let cloudsArray = [];
        let cloudTargetPercent = 50;
        function generateClouds(initialPercent = 50) {
            const layer = document.getElementById("clouds-layer");
            layer.innerHTML = '';
            cloudsArray = [];
            cloudTargetPercent = initialPercent;    
            const norm = normalizeCloudPercent(cloudTargetPercent);
            const {numClouds} = getCloudCount(norm);

            for (let i = 0; i < numClouds; i++) {
                const cloud = createCloud(norm);
                layer.appendChild(cloud);
                cloudsArray.push(cloud);
            }
        }
        function createCloud(norm) {
            const cloud = document.createElement("div");
            cloud.className = "absolute cloud";
            cloud.style.position = "absolute";
            cloud.style.top = Math.random() * 70 + "%";
            cloud.style.left = Math.random() * 100 + "%";
            cloud.dataset.speed = (0.001 + Math.random() * 0.005) * (0.5 + norm);
            cloud.style.opacity = 0.1 + norm * 0.6;
            const numCircles = 5 + Math.floor(Math.random() * 3);
            const baseWidth = 80 + Math.random() * 120;
            const baseHeight = 60 + Math.random() * 40;
            const mid = (numCircles - 1) / 2;

            for (let j = 0; j < numCircles; j++) {
                const circle = document.createElement("div");
                const distanceFromMid = Math.abs(j - mid);
                const sizeFactor = 1 - distanceFromMid / mid * 0.5;
                const widthFactor = (0.8 + 0.4 * sizeFactor) * (0.9 + 0.1 * norm);
                const heightFactor = (0.8 + 0.8 * sizeFactor) * (0.9 + 0.4 * norm);
                const w = baseWidth * widthFactor * (0.9 + Math.random() * 0.2);
                const h = baseHeight * heightFactor * (0.9 + Math.random() * 0.2);
                circle.style.width = w + "px";
                circle.style.height = h + "px";
                circle.style.background = "white";
                circle.style.borderRadius = "50%";
                circle.style.position = "absolute";
                circle.style.left = (j * baseWidth * 0.35) + "px";
                const baseline = baseHeight;
                const verticalOffset = baseline - h;
                circle.style.top = verticalOffset + "px";
                circle.style.filter = `blur(${2 + Math.random() * 3}px)`;
                cloud.appendChild(circle);
            }
            return cloud;
        }
        let lastTime = Date.now();
        function animateClouds() {
            const now = Date.now();
            const delta = (now - lastTime) / 16.67;
            lastTime = now;
            cloudsArray.forEach(cloud => {
                let left = parseFloat(cloud.style.left);
                left += parseFloat(cloud.dataset.speed) * delta;
                if (left > 100) left = -cloud.offsetWidth / window.innerWidth * 100;
                cloud.style.left = left + "%";
            const scale = 0.95 + 0.1 * Math.sin(Date.now() / 2000);
            cloud.style.transform = `scale(${scale})`;
        });
            requestAnimationFrame(animateClouds);
        }
        function updateCloudsDensity(cloudPercent) {
            cloudTargetPercent = cloudPercent;
            const norm = normalizeCloudPercent(cloudTargetPercent);
            const {numClouds} = getCloudCount(norm);
            cloudsArray.forEach(cloud => {
                cloud.style.opacity = 0.1 + norm * 0.6;
                cloud.dataset.speed = (0.001 + Math.random() * 0.005) * (0.5 + norm);
            });
            while (cloudsArray.length < numClouds) {
                const cloud = createCloud(norm);
                document.getElementById("clouds-layer").appendChild(cloud);
                cloudsArray.push(cloud);
            }
            while (cloudsArray.length > numClouds) {
                const cloud = cloudsArray.pop();
                cloud.remove();
            }
        }
        function normalizeCloudPercent(cloudPercent) {
            const min = 45;
            const max = 80;
            return Math.min(Math.max((cloudPercent - min) / (max - min), 0), 1);
        }
        function getCloudCount(norm) {
            const minClouds = 3;
            const maxClouds = 20;
            return { numClouds: Math.round(minClouds + norm * (maxClouds - minClouds)) };
        }

        generateClouds();
        animateClouds();

    </script>
</body>
</html>